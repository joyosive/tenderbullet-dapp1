Creating and running the middleware
====================================